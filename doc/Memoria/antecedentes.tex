% TFG - José Ángel Martín Baos. Escuela Superior de Informática. 2018
%%%% CHAPTER: Background %%%
% !TeX spellcheck = en_GB

\chapter{Background}
\label{chap:background}

\drop{T}{his} chapter aims to explain some important concepts that will be used as the base for the development of this \ac{BSc.} thesis. Firstly, an introduction about traffic flows and traffic emissions monitoring is discussed. Then, embedded systems are explained and how they can be implemented in traffic and environmental surveillance. It will go on to introduce Raspberry Pi systems and how they can be used in order to achieve the objectives of this \ac{BSc.} Thesis. Finally, H.264/AVC video codec is presented.

\section{\REDNOTE{Traffic flow}}

\REDNOTE{......}




\section{Traffic pollution}
% Introducción general a la problemática, a los sitemas actuales (proyecto europeo). Mencionar los contaminantes a medir. 
% Referencias: (consultar)
%	- Estimación espacio/temporal de la contaminación urbana asociada al tráfico: aplicación a la ciudad de México
%	- Traffic data for local emissions monitoring at a signalized intersection
% 	- Validation of road vehicle and traffic emission models
%	- Modelling instantaneous traffic emission and the influence of traffic speed limits
%	- European project --> https://ec.europa.eu/clima/policies/transport_en
%	- Air quality in Europe — 2016 report

Road transport is often the main source of air pollution in urban areas, for this reason there is an increasing need to estimate precisely its contribution to air pollution in the cities. Therefore, many authorities have developed some emissions models and systems in order to predict the road transport contribution to air pollution. Some systems, such as \ac{DTM} systems can focus on lower local emissions, using tools such as variable speed limits, ramp metering, adaptive signal timing \cite{MK10}, vehicle-class routing or prioritization \cite{ZDHB09}. These measures can generate some secondary effects such as longer travel delays, a decrease in the transit performance, or higher greenhouse gas emissions, therefore they should only be activated when they are warranted by air quality conditions \cite{EMA09} and, again, reliable emissions models are needed for this purpose. 

\subsection{Traffic pollution in Europe}
In Europe, transport represents a quarter of it's greenhouse gas emissions. Whereas the pollution generated by other sectors have been decreasing during the last years, the transport sector emissions only started to decrease in 2007 and they still remain higher than in 1990, as Figure \ref{fig:4-Emissions-Europe-2016} shows. Consequently, in July 2016, the European Commission adopted a low-emission mobility strategy, which aims to ensure that Europe stay competitive and it is able to respond the increasingly mobility needs of people and goods \cite{EuStrat}. 

The \acf{EEA} elaborates each year a report about the Air quality in Europe on the previous years \cite{AirQualityEEA17}. These reports analyse the different effects of air pollution, in addition with the sources and emissions of air pollutants. Moreover, the different pollutants and their concentration in Europe are described. In these reports, the \ac{EEA} propose a maximum concentration for some pollutants such as: PM\textsubscript{10} (small particles of metal, pollen, cement, etc dispersed in the air which diameter is less than 10 µm), PM\textsubscript{25}, O\textsubscript{3}, NO\textsubscript{2}, BaP, SO\textsubscript{2}, CO, and some others particles.

\begin{figure}[!h]
	\begin{center}
		\includegraphics[width=1\textwidth]{4-Emissions-Europe-2016.png}	
		\caption{Evolution of greenhouse gas emissions by sector (1990=100)}{Source: \acf{EEA}}
		\label{fig:4-Emissions-Europe-2016}
	\end{center}
\end{figure}

\BLUENOTE{For the development of this project two pollutants are going to be measured: CO and LPG. Carbon monoxide (CO) is one of the main pollutants gases measured for determining the quality of the air. CO is a colourless, odourless and tasteless toxic gas, which makes it a very dangerous gas over certain concentrations. It is generated from the partial oxidation of carbon compounds when there is not enough oxygen to produce carbon dioxide (CO\textsubscript{2}). CO is generated the exhaust of internal combustion engines or from the incomplete combustion of various fuels, therefore, it can be associated to vehicles, apart form other sources. Liquefied petroleum gas (LPG) is a mixture of hydrocarbon flammable gases such as propane or butane, used as fuel in heating appliances, cooking equipment and vehicles. It is not considered a pollutant gas by the \ac{EEA}, but it is going to be studied in this project because it presence is related with vehicle flows.}

% http://www.airqualitynow.eu/es/about_indices_definition.php
Some projects like \ac{CITEAIR} has been created by the European Union \cite{citeair} in order to develop efficient means to collect, present and compare air quality data across multiple European cites. One of the results of this project was the craation of the \emph{Air quality now} webpage \cite{airqualitynow}. This page provides a platform to compare real time air quality measurements in different cities of Europe. In this page, air quality is measured in three different time scales: hourly index during the last day, daily index of the previous day and an annual index. Each of this three time scales has five indices using a pollution scale that goes from 0 (very low) to 100 (very high). Six pollutants are measured, which are (PM10, NO2, O3, CO, PM2.5 and SO2). Then, the index is calculated depending on the amount of particles per hour (measured in $\mu g/m^3$), except for CO, in which a 8 hours moving average is used. Figure \ref{fig:4-Pollution-Index-Airqualitynow} shows the relationship between the pollutant measurement and its pollution index assigned.

\begin{figure}[!h]
	\begin{center}
		\includegraphics[width=1\textwidth]{4-Pollution-Index-Airqualitynow.png}	
		\caption{Relationship between the pollutant measurement and its pollution index assigned}{Source: Air Quality Now webpage \cite{airqualitynow}}
		\label{fig:4-Pollution-Index-Airqualitynow}
	\end{center}
\end{figure}

% Mencionar ciudades como casos de la problemática.
With the goal of evidencing the problem of traffic pollution in big cities, some examples has been selected. Air quality information about Madrid, Berlin and Paris taken on Tuesday 6th of February 2018 are shown in Figure \ref{fig:4-AirQuality-Details}.
As it can be observed, the pollution indices during that day were very high, especially in some cities such as Berlin, where its current roadside pollution level was very high (its index value between 75 and 100). Moreover, the previous day (\textit{yesterday} column of the figure) the traffic pollution was even greater, whit a pollution index over 50 for the three cities. For this reason, some measures should be taken those days, especially in Berlin. This evidence reinforces the fact that some pollution prevention and control mechanisms are necessary.

\begin{figure}[htb]
	\centering
	\subfigure[Madrid]{
		\includegraphics[width=0.74\textwidth]{4-Madrid-AirQuality.png}
		\label{fig:4-Madrid-AirQuality}
	}
	\subfigure[Berlin]{
		\includegraphics[width=0.74\textwidth]{4-Berlin-AirQuality.png}
		\label{fig:4-Berlin-AirQuality}
	}
	\subfigure[Paris]{
		\includegraphics[width=0.74\textwidth]{4-Paris-AirQuality.png}
		\label{fig:4-Paris-AirQuality}
	}
	\caption{Air Quality Details on 6th February 2018 at 18:00}
	\label{fig:4-AirQuality-Details}{Source: Air Quality Now webpage \cite{airqualitynow}}
\end{figure}



\section{Embedded systems}
% Sistemas Empotrados
An embedded system is an information processing system embedded into enclosing products such as cars, telecommunication or fabrication equipment \cite{Mar16}. Such systems come with some characteristics such as real-time constraints or efficiency requirements. Embedded systems are essential for providing ubiquitous information, which is one of the key goals of modern information technology and \ac{IoT} systems.

Embedded systems are dedicated to specific task, therefore computer engineers can optimize them to increase the performance and reliability trying to keep their size, cost and power consumption as low as possible. Many embedded systems are massively produced benefiting from economies of scales, which makes these devices really cheap. For this reason, embedded systems are present in lot of devices, from digital watches, to factory controllers or traffic lights systems. 

\subsection{Embedded systems in traffic or environmental surveillance}
% Buscar sistemas embebidos de control de tráfico o medio ambiental.
%	- https://acuraembedded.com/blog/acura-embedded-systems-to-reduce-carbon-emissions-for-public-transport-buses/
%	- ...
% MENCIONAR:
% Estas estaciones solo mide un punto de la ciudad, nosotros buscamos tecnologías baratas y que permitan controlar varios puntos
% Masivo
Embedded systems have been used from early ages to monitor traffic or environmental parameters. Nonetheless, traditionally, these weather and environmental stations (Figure \ref{fig:4-Environmental_Station_Murcia}) were huge and expensive devices that were only place in the outskirts of relevant cities. Therefore, the weather information of any location was obtained by interpolating the results of the nearest stations.

\begin{figure}[!h]
	\begin{center}
		\includegraphics[width=0.9\textwidth]{4-Environmental_Station_Murcia.jpg}
		\caption{Weather station in Murcia}
		\label{fig:4-Environmental_Station_Murcia}{Source: Cartagena IP TV}
	\end{center}
\end{figure}

Nowadays, lots of projects are being developed where modern embedded systems and IoT technologies are used to design weather stations. This provides lot of advantages, such as reducing the cost of these systems, or increasing the number of weather sensors that can be placed in a city (because of the scalability capabilities of these embedded systems). Taking all these into account, sensors can be located on several points of the city, and consequently, measures would be more accurate. Furthermore, better predictions can be made and, if they are combined with a distributed traffic flow control system, these devices can be used to feed a \ac{DSS} which helps authorities to mitigate environmental problems. In the next paragraphs, some example of embedded systems used for monitoring environmental parameters will be presented.

Acura\footnote{\url{https://acuraembedded.com/blog/acura-embedded-systems-to-reduce-carbon-emissions-for-public-transport-buses/}} is an example of an embedded system used to reduce carbon emission in public transport buses. This devices collect the vehicle location, emissions generated and fuel consumed by the buses and send this data to a control center where it is monitored in real-time. These statistics generated are used to reduce the vehicle's carbon footprint.

Bosch Climo\footnote{\url{http://www.boschclimo.com}} is an intelligent air monitoring embedded system designed by Bosch and Intel to evaluate, visualize and act upon the air quality. This solution allows to monitor the ambient air pollutants in real-time thanks to Wi-Fi, GSM and EDGE network connections. It used cloud-base analytics of data obtained from lot of sensors to facilitate the energy-efficiency, scalability and sustainability of real-world applications.

% TODO: Algún sistema empotrado más



% Air Pi
AirPi\footnote{\url{http://airpi.es/}} was a Raspberry Pi shield kit used to monitor temperature, humidity, pressure, light and UV levels, carmon, nitrogen dioxide and smoke levels. All the information was sent to a web page where it could be visualized. The good point about this kit was the fact that it was very cheap (it cost around 90 dollars).  Nevertheless, this project is no longer available.



\section{Raspberry Pi embedded system}
% Raspberry Pi 3 	-> Evolución
%					-> Comparativa con sus competidores
% 					-> Por qúe se ha elegido?
% !! Muy interesante:  https://www.raspberrypi.org/blog/vectors-from-coarse-motion-estimation/
%					->  Raspbian

% TODO




\section{Video format H.264/AVC}
\label{subsect:H.264}
Any video is composed by a sequence of images that are reproduced in a sequential way. In H.264/AVC video format and some others video standards each of this video images (or frames) can be classified into three types: I-Frame, P-Frame and B-Frame \cite{SC11}. Each of this frame types take advantage of different type of spatial or temporal redundancy of the video sequence: 
\begin{itemize}
	\item \textbf{I-Frame (Inter-frame).} The frame is encoded using only spatial redundancy inside the frame itself.
	\item \textbf{P-Frame (Predictive-frame).} The frame is encoded using as reference a previous I- or P- frame (temporal redundancy).
	\item \textbf{B-Frame (Bi-Predictive-frame).} The frame is encoded using more than one reference image (previous and past frames).
	\item \textbf{Other types}. The extended format of the H.264/AVC decoder support more complex types: SP (Switching P-frame) and SI (Switching I-frame).
\end{itemize}

\subsection{Macroblocks}
\label{subsect:Macroblocks}
A \emword{macroblock} is the basic unit in the video compression formats based on linear block transforms. It contain the information of a 16x16 pixels region of the frame. These blocks contains information about the luminance, the chrominance and the \emword{motion vectors} associated to them. Each macroblock can be divided into several block of lower size called partitions \cite{Gir14}, which varies from 16x16 to 4x4, as shown in Figure \ref{fig:4-Macroblocks}. In this figure, it is shown how a macroblock can be divided into two partitions of 16x8 or 8x16, our just in four partitions of 8x8, and each of this 8x8 partitions can be divided into two partitions of 8x4 or 4x8 or into four partitions of 4x4.

\begin{figure}[!h]
	\begin{center}
		\includegraphics[width=0.8\textwidth]{4-Macroblocks.png}
		\caption{Macroblock partitions}
		\label{fig:4-Macroblocks}
	\end{center}
\end{figure}


\subsection{Motion vectors}
A motion vector represent a temporal redundancy pattern between two frames in H.264/AVC and defines a distance and a direction in the form of a bidimensional vector. In other words, they represent the movement of a certain macroblock in the actual image with respect to the reference image. Figure \ref{fig:4-Car_with_MV} shows an example of the motion vectors generated by a Raspberry Pi while recording video in a street. Therefore, instead of storing all the pixels for the current frame, the motion vectors corresponding with the macroblocks that have been identified in the reference image are stored, which saves lot of space when storing the video.

PiCamera motion data values for each macroblock are 4-bytes long, as it consist in 1-byte $x$ vector, 1-byte $y$ vector and two 2-byte \ac{SAD} value. If, for example, the resolution of the video is 640x480, there will be 41 columns of macroblocks (640 pixels / 16 pixels per macroblock + 1, as PiCamera generates one extra column), and 30 rows (480 pixels / 16 pixels per macroblock). Therefore, each frame generates $41\times30\times4 = 4920$ bytes, which is less than 5KB of motion data.

\begin{figure}[!h]
	\begin{center}
		\includegraphics[width=0.8\textwidth]{4-Car_with_MV.png}
		\caption{Example of  the \emword{motion vectors} taken by the Raspberry Pi}
		\label{fig:4-Car_with_MV}
	\end{center}
\end{figure}

Motion vectors can be represented using its Cartesian coordinates as shown in Equation (\ref{eq:4-mv-cartesian}), where $x$ and $y$ represents the original position of the macroblock in the first frame and $I_{x}$ and $I_{y}$ represents the increments of the vector in each of its coordinates.
\begin{equation} \label{eq:4-mv-cartesian}
mv_{i} = (x, y, I_{x}, I_{y})
\end{equation}
Nevertheless, the motion vectors can also be represented usign polar coordinates $r$ and $\theta$ \cite{GRMSJ12}. Therefore, each motion vector can be represented as shown in Equation (\ref{eq:4-mv-polar}).
\begin{equation} \label{eq:4-mv-polar}
mv_{i} = (x, y, r, \theta)
\end{equation}

Motion vectors are used in this project to detect the number vehicles that cross a street in a certain amount of time so as to obtain the vehicle flow. In the next chapter the methodology used in this \ac{BSc.} thesis is described.



